[config]
skip_core_tasks = true

[tasks.setup]
workspace = false
description = "Install dependencies and generate certificates"
script = '''
#!/bin/bash
set -e

echo "Setting up Lightyear development environment..."

# Install WASM target
echo "Installing wasm32-unknown-unknown target..."
rustup target add wasm32-unknown-unknown

# Install Bevy CLI if not already installed
if ! command -v bevy &> /dev/null; then
    echo "Installing Bevy CLI..."
    cargo install bevy_cli
else
    echo "Bevy CLI already installed"
fi

# Generate certificates
echo "Generating certificates..."
cargo make generate-certs

echo "Setup complete!"
echo ""
echo "To run:"
echo "  Server:  cargo server"
echo "  Client:  cargo client"
echo "  Web:     cargo web"
'''

[tasks.generate-certs]
workspace = false
description = "Generate self-signed certificates for WebTransport/WebSocket"
script = '''
#!/bin/bash
set -e

CERT_DIR="certificates"
mkdir -p "$CERT_DIR"
cd "$CERT_DIR"

echo "Generating self-signed certificate..."

openssl req -x509 \
    -newkey ec \
    -pkeyopt ec_paramgen_curve:prime256v1 \
    -keyout key.pem \
    -out cert.pem \
    -days 14 \
    -nodes \
    -subj "/CN=localhost"

echo "Extracting certificate digest..."

FINGERPRINT=$(openssl x509 -in cert.pem -noout -sha256 -fingerprint | \
    sed 's/^.*=//' | sed 's/://g')

echo -n "$FINGERPRINT" > digest.txt

echo "Certificate generated successfully!"
echo "Digest: $FINGERPRINT"
'''

[tasks.web]
description = "Run WASM client with automatic certificate generation"
workspace = false
dependencies = ["ensure-certs"]
script = '''
#!/bin/bash
set -e

echo "Starting WASM client with Bevy CLI..."
cd crates/web
bevy run web "$@"
'''

[tasks.ensure-certs]
description = "Ensure certificates exist, generate if missing"
workspace = false
script = '''
#!/bin/bash
set -e

if [ ! -f "certificates/digest.txt" ]; then
    echo "Certificates not found, generating..."
    bash certificates/generate.sh
else
    echo "Certificates found"
fi
'''

[tasks.test-native]
description = "Run all native tests (excludes WASM)"
workspace = false
command = "cargo"
args = ["test", "--workspace", "--exclude", "web"]

[tasks.test-all]
description = "Run all tests including WASM (WARNING: WASM compilation is very resource-intensive)"
workspace = false
dependencies = ["ensure-certs"]
run_task = { name = ["test-native", "test-wasm"], parallel = false }

[tasks.test-wasm]
description = "Run WASM tests (Optimized: ~4GB RAM, 5-10 minutes)"
workspace = false
script = '''
#!/bin/bash
echo "⚠️  WASM tests compile Bevy for wasm32-unknown-unknown (optimized for low memory)"
echo "   Resource usage: ~4GB RAM with size optimizations and limited parallelism"
echo "   Time: 5-10 minutes on first build, ~2-3 minutes with incremental cache"
echo ""
# Add cargo bin to PATH
export PATH="$HOME/.cargo/bin:$PATH"
# Limit parallel jobs to reduce RAM usage (CARGO_BUILD_JOBS applies only to this command)
# Use CARGO_PROFILE env var to set the profile
CARGO_BUILD_JOBS=2 CARGO_PROFILE=wasm-test wasm-pack test --headless --firefox crates/web
'''
